---
title: CircleCI Provider
description: CircleCI-specific features, workarounds, and configuration options
---

import { Code, Aside, Steps, CardGrid, Card } from '@astrojs/starlight/components';

The CircleCI provider generates CircleCI configuration files from cigen's universal format, including several CircleCI-specific features and workarounds to address platform limitations.

## Basic Configuration

<Code code={`provider: circleci
output_path: .circleci
output_filename: config.yml

circleci:
  fix_github_status: true  # Auto-inject GitHub status patch job`} lang="yaml" title="Basic CircleCI configuration" />

## CircleCI-Specific Features

### GitHub Status Fix

<Aside type="caution">
**Required Environment Variable**: `GITHUB_PERSONAL_ACCESS_TOKEN` with `repo:status` permissions must be configured in CircleCI project settings.
</Aside>

CircleCI has a limitation where approval jobs don't properly update GitHub commit statuses, causing GitHub branch protection rules to fail even when approvals are granted.

When `circleci.fix_github_status: true` is enabled, cigen automatically injects a `patch_approval_jobs_status` job that:

<Steps>
1. **Waits** for all test jobs to complete
2. **Uses GitHub API** to manually set approval job statuses to "success"
3. **Allows** GitHub branch protection rules to pass
</Steps>

<Code code={`circleci:
  fix_github_status: true

# Automatically injected when workflow contains approval jobs
jobs:
  patch_approval_jobs_status:
    image: cimg/ruby:3.3.5
    resource_class: small
    requires: [all_test_jobs]
    steps:
      - run:
          name: Set Approval Jobs Status to Success on GitHub
          command: |
            # Uses GitHub API to update commit statuses
            # Requires GITHUB_PERSONAL_ACCESS_TOKEN environment variable`} lang="yaml" title="GitHub status fix" />

**Setup Instructions**:
1. Create a GitHub personal access token with `repo:status` scope
2. Add it to CircleCI project as `GITHUB_PERSONAL_ACCESS_TOKEN`
3. Enable the feature in your cigen configuration

### Multi-Architecture Jobs

<Code code={`jobs:
  build_image:
    image: cimg/base:stable
    architectures: [amd64, arm64]  # Creates separate jobs
    steps:
      - run: docker build -t myapp:latest .

# Generated output:
jobs:
  build_image_amd64:
    docker:
      - image: cimg/base:stable
    resource_class: medium

  build_image_arm64:
    docker:
      - image: cimg/base:stable
    resource_class: arm.medium`} lang="yaml" title="Multi-architecture builds" />

Cigen automatically:
- Creates separate jobs for each architecture
- Maps resource classes appropriately (`medium` vs `arm.medium`)
- Maintains proper dependency chains in workflows

### Approval Jobs

<Code code={`jobs:
  approve_deploy:
    type: approval  # Maps to CircleCI approval type

  deploy_production:
    image: cimg/base:stable
    context: [production-secrets]
    requires: [approve_deploy]
    steps:
      - run: ./deploy.sh`} lang="yaml" title="Approval jobs" />

## Advanced Features

### OR Dependencies Workaround

<Aside type="tip">
CircleCI doesn't natively support OR dependencies. Cigen implements this using automated approval shim jobs with CircleCI API calls.
</Aside>

<Code code={`jobs:
  build_app_image:
    requires_any: [manual_approval, automated_trigger]
    steps:
      - run: docker build -t app:latest .

# Cigen automatically creates:
jobs:
  manual_approval_shim:
    type: approval
    requires: [manual_approval]
    steps:
      - automated_approval: build_app_image

  automated_trigger_shim:
    requires: [automated_trigger]
    steps:
      - automated_approval: build_app_image`} lang="yaml" title="OR dependencies implementation" />

This allows `build_app_image` to run when either:
- Someone manually approves `manual_approval`, OR
- The `automated_trigger` job completes successfully

### Dynamic Configuration

<Code code={`setup: true  # or dynamic: true

parameters:
  run_tests:
    type: boolean
    default: false
    description: 'Whether to run test jobs'

  deploy_environment:
    type: enum
    enum: [staging, production]
    default: staging`} lang="yaml" title="Dynamic configuration" />

Enables CircleCI's dynamic configuration features:
- Conditional workflow execution
- Setup workflows that determine which jobs to run
- Parameter-driven job execution

### Context Support

<Code code={`jobs:
  deploy_production:
    image: cimg/base:stable
    context:
      - production-secrets
      - aws-credentials
    steps:
      - run: ./deploy.sh`} lang="yaml" title="CircleCI contexts" />

Maps directly to CircleCI contexts for environment-specific secrets and variables.

## Built-in Template Commands

Cigen includes CircleCI-specific template commands:

<CardGrid>
  <Card title="checkout" icon="git-branch">
    Standard git checkout with CircleCI optimizations
  </Card>
  <Card title="restore_cache / save_cache" icon="rocket">
    Automatic cache key generation with intelligent fallbacks
  </Card>
  <Card title="automated_approval" icon="approve-check">
    API-based job approval for OR dependency workarounds
  </Card>
</CardGrid>

### Automated Approval Command

<Code code={`steps:
  - automated_approval: target_job_name

# Generates CircleCI API calls:
steps:
  - run:
      name: Approve target job via API
      command: |
        curl -X POST \\
          "https://circleci.com/api/v2/workflow/\${CIRCLE_WORKFLOW_ID}/approve/\${JOB_ID}" \\
          -H "Circle-Token: \${CIRCLE_TOKEN}"`} lang="yaml" title="Automated approval implementation" />

## Environment Variables

Required for various CircleCI features:

<CardGrid>
  <Card title="GitHub Status Fix" icon="github">
    `GITHUB_PERSONAL_ACCESS_TOKEN` - GitHub API access for status updates
  </Card>
  <Card title="OR Dependencies" icon="list-format">
    `CIRCLE_TOKEN` - CircleCI API access for automated approvals
  </Card>
  <Card title="Automatic Variables" icon="setting">
    `CIRCLE_SHA1`, `CIRCLE_BUILD_URL`, etc. - Provided by CircleCI
  </Card>
</CardGrid>

## Validation

The generator automatically validates configurations:

<Steps>
1. **Schema validation** against CircleCI requirements
2. **CircleCI CLI validation** if `circleci` command is available:
   ```bash
   circleci config validate .circleci/config.yml
   ```
3. **Dependency graph validation** for circular references
4. **Resource class compatibility** checking
</Steps>

## Limitations & Workarounds

<CardGrid>
  <Card title="GitHub Status Updates" icon="github">
    **Problem**: Approval jobs don't update GitHub statuses
    **Solution**: Auto-injected API-based status patch job
  </Card>
  <Card title="OR Dependencies" icon="list-format">
    **Problem**: No native "requires any of" support
    **Solution**: Automated approval shim jobs using API
  </Card>
  <Card title="Multi-Architecture" icon="laptop">
    **Problem**: No built-in matrix builds
    **Solution**: Generate separate jobs with arch suffixes
  </Card>
</CardGrid>

## Best Practices

### Configuration Organization

<Code code={`# Use contexts for environment-specific secrets
jobs:
  deploy_staging:
    context: [staging-secrets]
  deploy_production:
    context: [production-secrets]

# Enable GitHub status fix when using approvals
circleci:
  fix_github_status: true

# Use dynamic workflows for job skipping
setup: true`} lang="yaml" title="CircleCI best practices" />

### Resource Class Mapping

Cigen automatically maps generic resource classes to CircleCI-specific ones:

| Generic | AMD64 | ARM64 |
|---------|-------|-------|
| `small` | `small` | `arm.small` |
| `medium` | `medium` | `arm.medium` |
| `large` | `large` | `arm.large` |
| `xlarge` | `xlarge` | `arm.xlarge` |

### Cache Configuration

<Code code={`# Leverage CircleCI's cache restoration patterns
cache:
  gems:
    # Automatic fallback keys for partial matches
    # Key: gems-ruby3.3.0-abc123
    # Fallback: gems-ruby3.3.0-
    # Fallback: gems-ruby3.3.0
    checksum_sources: [Gemfile.lock]
    paths: [vendor/bundle]`} lang="yaml" title="CircleCI cache patterns" />

## Migration from CircleCI YAML

When migrating existing CircleCI configurations:

<Steps>
1. **Convert docker arrays** to separate `image` and `services` sections
2. **Replace manual cache steps** with `cache: [type]` definitions
3. **Move commands** to separate files in `commands/` directory
4. **Convert approval jobs** to `type: approval`
5. **Add schema validation** with `$schema` property
6. **Enable automatic features** like `fix_github_status`
</Steps>

## Example Migration

<Code code={`# Before (CircleCI YAML)
version: 2.1
jobs:
  test:
    docker:
      - image: cimg/ruby:3.3
      - image: postgres:15
        environment:
          POSTGRES_PASSWORD: test
    steps:
      - checkout
      - restore_cache:
          keys:
            - gems-{{ checksum "Gemfile.lock" }}
      - run: bundle install
      - save_cache:
          key: gems-{{ checksum "Gemfile.lock" }}
          paths: [vendor/bundle]

# After (Cigen format)
$schema: https://cigen.dev/schemas/v1/config-schema.json
provider: circleci

services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: test

jobs:
  test:
    image: cimg/ruby:3.3
    services: [postgres]
    cache: gems
    steps:
      - checkout
      - run: bundle install`} lang="yaml" title="CircleCI migration example" />

The cigen version is cleaner, more maintainable, and includes automatic optimizations like intelligent cache key generation and service container management.