image: cimg/ruby:3.3.5
architectures: ["amd64", "arm64"]
resource_class: medium
requires: ["install_gems"]
source_files: ruby

services: ["postgres", "redis"]

restore_cache:
  - gems
  - bootsnap

steps:
  - run:
      name: Setup database
      command: bundle exec rails db:create db:schema:load --trace

  - run:
      name: RuboCop
      command: |
        rubocop -V
        # First run: Auto-correct everything possible
        if ! rubocop -A; then
          # Either there were changes made, or there are unfixable issues
          # Run again to show the remaining issues or confirm all is fixed
          rubocop
        fi

  - run:
      name: Copy .env.test to .env.development (for Tapioca)
      command: cp .env.test .env.development

  - run:
      name: Sorbet RBI Generation
      command: |
        tapioca dsl
        tapioca gem

  - run:
      name: Sorbet Typecheck
      command: |
        srb --version
        srb tc

  - run:
      name: Zeitwerk Check
      command: rails zeitwerk:check

  - run:
      name: Haml Lint
      command: |
        haml-lint -v
        haml-lint app/views

  - run:
      name: Brakeman
      command: |
        brakeman -v
        ./scripts/ci/brakeman

  - run:
      name: FactoryBot Lint
      command: rake factory_bot:lint

  - run:
      name: Traceroute
      command: ./scripts/ci/traceroute

  - run:
      name: bundler-audit
      command: ALLOW_UPDATES_ON_CI=true ./scripts/ci/bundler-audit

  - run:
      name: Validate all files are classified correctly
      command: ./scripts/ci/validate_file_classifications

  # Only push changes to GitHub for amd64 builds, skip for arm64
  - commit_and_push_changed_files:
      pathspecs: |
        [
          {
            "pathspec": "Gemfile.lock",
            "update_command": "bundler-audit"
          },
          {
            "pathspec": "sorbet/rbi/gems",
            "update_command": "tapioca gem"
          },
          {
            "pathspec": "sorbet/rbi/dsl",
            "update_command": "tapioca dsl"
          },
          {
            "pathspec": "*.rb",
            "update_command": "rubocop -A"
          }
        ]

  - run:
      name: Model Annotations
      command: ./scripts/ci/annotate_models

  # Commit and push model annotations separately (amd64 only)
  - commit_and_push_changed_files:
      pathspecs: |
        [{
          "pathspec": "*.rb",
          "update_command": "./scripts/ci/annotate_models"
        }]
