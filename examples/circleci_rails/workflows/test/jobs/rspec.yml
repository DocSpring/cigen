image: ci_app_base
architectures: ["arm64", "amd64"]
resource_class: large
source_files: rspec
parallelism: 2

restore_cache:
  - gems
  - npm_packages
  - name: bootsnap
    dependency: false
  - rails_assets

services:
  - postgres
  - redis
  - minio

steps:
  - setup_database
  - run:
      name: Split RSpec tests by timing
      command: |
        circleci tests glob "spec/**/*_spec.rb" \
          | circleci tests split --split-by=timings \
          > /tmp/split-rspec-tests

  - run:
      name: Run RSpec
      command: |
        rspec \
          --seed << pipeline.number >> \
          --format RspecJunitFormatter \
          --out spec/results/rspec.xml \
          $(cat /tmp/split-rspec-tests)

  - run:
      name: Delete artifacts for successful job
      command: rm -rf spec/artifacts log
  - store_test_results:
      path: spec/results/rspec.xml
  - store_artifacts:
      path: spec/artifacts
  - store_artifacts:
      path: coverage
  - store_artifacts:
      path: log
