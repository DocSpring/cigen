# CI Config Comparison: Ruby vs Cigen

## Overview

This tool compares the OLD Ruby-generated CircleCI config with the NEW cigen-generated config to verify the migration is complete and correct.

## File Locations

- **OLD (Ruby-generated)**: `/Users/ndbroadbent/code/docspring/.circleci/test_and_deploy_config.yml`
  - Generated by: `lib/tools/generate_circle_ci_config.rb` + source files in `src/`
  - Size: 143KB
  - Branch: `nathan/sc-3286/extra-tweaks-to-api-proxy-redis-pub-sub`

- **NEW (cigen-generated)**: `./docspring/.circleci/main.yml` (symlink to worktree)
  - Generated by: cigen from `.cigen/` config
  - Size: 170KB
  - Worktree: `/Users/ndbroadbent/code/docspring-worktrees/nathan-cigen-config`

## Structural Comparison

### Parameters

| OLD (8)                   | NEW (3)                   |
| ------------------------- | ------------------------- |
| build                     | -                         |
| check_package_versions    | check_package_versions    |
| deploy_all                | -                         |
| deploy_eu                 | -                         |
| deploy_us                 | -                         |
| run_all_jobs              | -                         |
| run_staging_postman_tests | run_staging_postman_tests |
| skip_cache                | skip_cache                |

**Missing in NEW**: `build`, `deploy_all`, `deploy_eu`, `deploy_us`, `run_all_jobs`

### Orbs

| OLD               | NEW          |
| ----------------- | ------------ |
| codecov           | codecov      |
| git-shallow-clone | -            |
| slack             | slack        |
| -                 | continuation |

**Changes**: `git-shallow-clone` orb replaced with built-in `cigen_shallow_checkout` command. `continuation` orb added for dynamic pipeline setup.

### Jobs

- **OLD**: 48 jobs
- **NEW**: 54 jobs
- **In BOTH**: 1 (`postman_staging`)

#### Naming Convention Change

Cigen uses a stage-prefixed naming convention:

| OLD Pattern                | NEW Pattern                      | Stage       |
| -------------------------- | -------------------------------- | ----------- |
| `api_proxy`                | `ci_api_proxy`                   | ci          |
| `rspec_amd64`              | `ci_rspec`                       | ci          |
| `build_app_image_amd64`    | `build_build_app_image`          | build       |
| `convox_create_release_eu` | `build_convox_create_release-eu` | build       |
| `convox_pre_release_eu`    | `deploy_eu_pre_release`          | deploy_eu   |
| `merge_branch`             | `post_deploy_merge`              | post_deploy |

#### Jobs Only in OLD (48)

```
api_proxy
api_proxy_integration
approve_build_app_image_eu
approve_build_app_image_staging
approve_build_app_image_us
bootsnap_precompile_amd64
build_app_image_amd64
build_docker_images_amd64
compile_client_webpack_production
compile_client_webpack_test
compile_docs
compile_rails_assets_production
compile_rails_assets_test
convox_create_release_eu
convox_create_release_staging
convox_create_release_us
convox_pre_release_eu
convox_pre_release_staging
convox_pre_release_us
convox_promote_eu
convox_promote_staging
convox_promote_us
convox_request_approval_eu
convox_request_approval_staging
convox_request_approval_us
deploy_all
deploy_docs
deploy_push_embedded_assets_to_s3
developer_setup
docs_lint
ensure_branch_up_to_date
install_app_npm_packages
install_docs_npm_packages
install_gems_amd64
js_lint
merge_branch
patch_approval_jobs_status
patch_approve_deploy_all
prettier
request_deploy_approvals
rspec_amd64
rspec_passed_amd64
rswag_amd64
ruby_lint
secrets
shellcheck
slack_ci_passed
```

#### Jobs Only in NEW (54)

```
build_build_app_image
build_build_docker_images
build_build_enterprise_image
build_compile_client_webpack_production
build_compile_rails_assets_production
build_convox_create_release-eu
build_convox_create_release-staging
build_convox_create_release-us
build_create_app_docker_manifest
build_create_enterprise_docker_manifest
ci_api_proxy
ci_api_proxy_integration
ci_bootsnap
ci_compile
ci_compile_client_webpack_test
ci_compile_rails_assets_test
ci_developer_setup
ci_docs_lint
ci_ensure_branch_up_to_date
ci_install_app_npm_packages
ci_install_docs_npm_packages
ci_install_gems
ci_js_lint
ci_prettier
ci_rspec
ci_rspec_passed
ci_rswag
ci_ruby_lint
ci_secrets
ci_shellcheck
ci_slack_ci_passed
deploy_all_deploy_all
deploy_docs_deploy
deploy_eu_approve_build
deploy_eu_deploy
deploy_eu_pre_release
deploy_eu_promote
deploy_eu_request_approval
deploy_staging_approve_build
deploy_staging_deploy
deploy_staging_postman
deploy_staging_pre_release
deploy_staging_promote
deploy_staging_push_assets
deploy_staging_request_approval
deploy_us_approve_build
deploy_us_deploy
deploy_us_pre_release
deploy_us_promote
deploy_us_request_approval
package_updates
post_deploy_merge
post_deploy_patch_approve_deploy_all
```

### Commands

- **OLD**: 39 commands
- **NEW**: 46 commands

#### Commands Only in OLD (2)

- `request_deploy_approval`
- `shallow_checkout`

#### Commands Only in NEW (9)

- `cigen_shallow_checkout` (replaces `shallow_checkout` and `git-shallow-clone` orb)
- `codecov_upload`
- `compile_docs`
- `convox`
- `convox_deploy_app`
- `fail_fast`
- `slack_ci_starting_notification`
- `update_docker_package`
- `update_ruby_security_vulnerabilities`

### Workflows

| OLD               | NEW                   |
| ----------------- | --------------------- |
| test_build_deploy | main                  |
| -                 | package_updates       |
| -                 | staging_postman_tests |

### docker_images Section

- **OLD**: Has a `docker_images` section with 13 YAML anchors for Docker image definitions
- **NEW**: No `docker_images` section - handled differently in cigen via `config/docker_images.yml`

## Cigen Config Structure

```
docspring/.cigen/
├── commands/           # 47 command definitions
├── config/
│   ├── cache_definitions.yml
│   ├── docker_build.yml
│   ├── docker_images.yml
│   └── source_file_groups.yml
├── config.yml          # Main cigen config
├── templates/
└── workflows/
    ├── main/
    │   ├── config.yml
    │   └── jobs/
    │       ├── build/      # Build stage jobs
    │       ├── ci/         # CI stage jobs
    │       ├── deploy/     # Deploy stage jobs
    │       ├── deploy_all/
    │       ├── deploy_docs/
    │       └── post_deploy/
    ├── package_updates/
    │   ├── config.yml
    │   └── jobs/
    └── staging_postman_tests/
        ├── config.yml
        └── jobs/
```

## Key Cigen Features

From `config.yml`:

- `provider: circleci`
- `dynamic: true` - Uses dynamic pipeline setup
- `circleci.fix_github_status: true` - Auto-injects patch_approval_jobs_status
- Global shallow checkout configuration
- Centralized Docker auth configuration
- Services definitions (postgres, redis, minio)

## Goal of Comparison

1. **Verify nothing was lost** - Every feature from OLD should have an equivalent in NEW
2. **Verify nothing wrong was added** - No AI-generated shortcuts or mistakes
3. **Identify old techniques** - Find places where NEW uses old patterns instead of proper cigen methods
4. **Complete the migration** - Ensure cigen config leverages ALL cigen features

## Status

**NOT YET COMPARED**: The .cigen config is not done, some things are wrong, and some things use old techniques instead of proper cigen methods. This comparison will help identify and fix those issues.
