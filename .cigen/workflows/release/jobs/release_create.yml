image: ubuntu-latest

requires:
  - release_build

steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 0
      fetch-tags: true

  - name: Download artifacts
    uses: actions/download-artifact@v4
    with:
      path: artifacts

  - id: version
    name: Get version from Cargo.toml
    run: |
      VERSION=$(grep -E '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
      {
        echo "version=$VERSION"
      } >> "$GITHUB_OUTPUT"

      if [ "${{ github.event_name }}" = "push" ]; then
        TAG="${GITHUB_REF#refs/tags/}"
        EXPECTED_TAG="v$VERSION"
        if [ "$TAG" != "$EXPECTED_TAG" ]; then
          echo "Error: Tag $TAG doesn't match expected $EXPECTED_TAG from Cargo.toml" >&2
          exit 1
        fi
        {
          echo "tag=$TAG"
        } >> "$GITHUB_OUTPUT"
      else
        {
          echo "tag=v$VERSION"
        } >> "$GITHUB_OUTPUT"
      fi

  - run:
      name: Generate checksums
      command: |
        set -e
        cd artifacts
        for dir in */; do
          cd "$dir"
          for file in *; do
            case "$file" in
              *.tar.gz|*.zip)
                if [ -f "$file" ]; then
                  sha256sum "$file" > "${file}.sha256" || shasum -a 256 "$file" | awk '{print $1}' > "${file}.sha256"
                fi
                ;;
            esac
          done
          cd ..
        done
        cd ..

  - run:
      name: Generate changelog
      command: |
        cat > changelog.md <<EOF
        ## Installation

        ### One-liner (Linux/macOS)
            curl -fsSL https://docspring.github.io/cigen/install.sh | sh

        ### Direct downloads
        - macOS (Intel): https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/cigen-macos-amd64.tar.gz
        - macOS (Apple Silicon): https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/cigen-macos-arm64.tar.gz
        - Linux (x86_64): https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/cigen-linux-amd64.tar.gz
        - Linux (ARM64): https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/cigen-linux-arm64.tar.gz
        EOF

  - name: Create GitHub Release
    uses: softprops/action-gh-release@v2
    with:
      tag_name: ${{ steps.version.outputs.tag }}
      name: CIGen v${{ steps.version.outputs.version }}
      body_path: changelog.md
      draft: false
      prerelease: ${{ contains(steps.version.outputs.tag, '-') }}
      files: |
        artifacts/**/*.tar.gz
        artifacts/**/*.sha256
