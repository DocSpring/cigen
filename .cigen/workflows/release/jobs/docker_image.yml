image: ubuntu-latest

requires:
  - release_create

permissions:
  contents: read

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

checkout:
  fetch-depth: 0

steps:
  - name: Extract version
    run: |
      VERSION=$(grep -E '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
      echo "DOCKER_IMAGE_VERSION=$VERSION" >> "$GITHUB_ENV"

  - name: Set up QEMU
    uses: docker/setup-qemu-action@v3

  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v3

  - name: Log in to Docker Hub
    uses: docker/login-action@v3
    with:
      username: ${{ env.DOCKERHUB_USERNAME }}
      password: ${{ env.DOCKERHUB_TOKEN }}

  - run:
      name: Build and push multi-arch image
      command: |
        set -euo pipefail
        VERSION="${{ env.DOCKER_IMAGE_VERSION }}"
        echo "Building docspringcom/cigen:${VERSION} and :latest"
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          -f Dockerfile \
          --build-arg CIGEN_VERSION="${VERSION}" \
          -t docspringcom/cigen:"${VERSION}" \
          -t docspringcom/cigen:latest \
          --push .
