image: cimg/ruby:3.3.5
resource_class: small

requires:
{% for job in test_jobs -%}
  - {{ job }}
{% endfor %}
steps:
  - run:
      name: Set Approval Jobs Status to Success on GitHub
      command: |
        #!/bin/bash
        set -euo pipefail

        APPROVAL_JOBS=({% for job in approval_jobs %}{{ job }}{% if not loop.last %} {% endif %}{% endfor %})

        echo "Patching approval jobs: ${APPROVAL_JOBS[@]}" >&2
        echo "----------------------------------------------------------------" >&2

        update_commit_statuses() {
          COMMIT_STATUSES_RESPONSE="$(curl -sfL --request GET \
            --url "https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/commits/$CIRCLE_SHA1/statuses?per_page=100" \
            --header 'Accept: application/vnd.github.v3+json' \
            --header "Authorization: Bearer $GITHUB_PERSONAL_ACCESS_TOKEN")"
          COMMIT_STATUSES="$(echo "$COMMIT_STATUSES_RESPONSE" | jq -r '.[].context')"
        }

        update_commit_statuses

        for APPROVAL_JOB in "${APPROVAL_JOBS[@]}"; do
          echo
          CIRCLECI_JOB_NAME="{{ workflow_name }}/${APPROVAL_JOB}"
          echo "Patching approval job: $CIRCLECI_JOB_NAME" >&2

          FOUND_APPROVAL_JOB="false"

          for i in {1..10}; do
            if echo "$COMMIT_STATUSES" | grep -q "ci/circleci: $CIRCLECI_JOB_NAME"; then
              echo "Found approval job in commit statuses: $CIRCLECI_JOB_NAME" >&2
              FOUND_APPROVAL_JOB="true"
              break
            else
              echo "Approval job not found in commit statuses (attempt $i/10): $CIRCLECI_JOB_NAME" >&2
              echo "Waiting 3 seconds..." >&2
              sleep 3
              update_commit_statuses
            fi
          done

          if [ "$FOUND_APPROVAL_JOB" == "true" ]; then
            echo "Setting approval job status to success: $CIRCLECI_JOB_NAME" >&2
            curl -sfL --request POST \
              --url "https://api.github.com/repos/$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME/statuses/$CIRCLE_SHA1" \
              --header 'Accept: application/vnd.github.v3+json' \
              --header "Authorization: Bearer $GITHUB_PERSONAL_ACCESS_TOKEN" \
              --header 'Content-Type: application/json' \
              --data "{
                \"state\": \"success\",
                \"target_url\": \"$CIRCLE_BUILD_URL\",
                \"description\": \"This approval job was automatically approved\",
                \"context\": \"ci/circleci: $CIRCLECI_JOB_NAME\"
              }"
          fi

          if [ "$FOUND_APPROVAL_JOB" == "false" ]; then
            echo "Could not patch CircleCI approval, timed out." >&2
            echo "COMMIT_STATUSES_RESPONSE: $COMMIT_STATUSES_RESPONSE" >&2
            echo "COMMIT_STATUSES: $COMMIT_STATUSES" >&2
          fi
        done